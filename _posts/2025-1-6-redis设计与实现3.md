---
layout: post
title: "《redis设计与实现》 第三部分 多机数据库的实现"
date:   2025-1-31
tags: [redis, 底层, 书籍]
comments: true
author: huanghuoguoguo
---
## 第三部分 多机数据库的实现

### 第十五章 复制

Redis 的复制功能是其高可用性和数据冗余的重要组成部分，通过将主服务器的数据复制到一个或多个从服务器，实现数据的备份和负载均衡。这一章详细介绍了 Redis 复制的旧版和新版实现，包括命令传播、复制过程中的缺陷、部分重同步的实现，以及心跳检测机制。

### 15.1 旧版复制功能的实现

p199 SYNC命令执行步骤
p200 命令传播

旧版复制功能主要依赖于 `SYNC` 命令。`SYNC` 命令的执行步骤包括：

1. 从服务器向主服务器发送 `SYNC` 命令请求。
2. 主服务器开始生成 RDB 文件并将其发送给从服务器。
3. 从服务器接收 RDB 文件并加载数据，完成初次同步。
4. 在数据同步完成后，主服务器将后续的写命令传播给从服务器。

命令传播是指主服务器将执行的写命令发送给所有从服务器，以保持数据的一致性。

### 15.2 旧版复制功能的缺陷

p201 初次复制和断线后重复制
p203 SYNC命令是一个非常耗费资源的操作

旧版复制功能存在一些缺陷，主要体现在初次复制和断线后重复制的效率上。`SYNC` 命令在执行时会导致主服务器阻塞，生成 RDB 文件的过程非常耗费资源，尤其是在数据量较大时。此外，若从服务器与主服务器的连接中断，重新连接后需要重新执行 `SYNC` 命令进行全量复制，导致性能下降和资源浪费。

### 15.3 新版复制功能的实现

p203 完整重同步和部分重同步

新版复制功能引入了完整重同步和部分重同步的概念。完整重同步是指从服务器在初次连接时从主服务器获取完整数据，而部分重同步则允许从服务器在与主服务器断开连接后，能够仅同步主服务器自断开以来的增量数据，从而提高效率。

### 15.4 部分重同步的实现

p205 复制偏移量

p206 复制积压缓冲区

p206 固定长度先进先出队列
p209 根据需要调整复制积压缓冲区大小
p208 服务器运行ID

部分重同步的实现依赖于复制偏移量和复制积压缓冲区。复制偏移量用于记录主服务器已发送给从服务器的最后一个命令的位置。复制积压缓冲区是一个固定长度的先进先出队列，存储最近的命令，以便在从服务器重新连接时能够快速恢复数据。根据需要，Redis 可以动态调整复制积压缓冲区的大小，以适应不同的网络条件和数据流量。每个服务器都有一个唯一的运行 ID，用于标识主从服务器之间的连接。

### 15.5 PSYNC命令的实现

p209 PSYNC命令的两种调用方法
p209 接收到PSYNC命令的主服务器向从服务器返回的三种回复

`PSYNC` 命令是新版复制的核心命令，支持两种调用方法：全量同步和部分同步。接收到 `PSYNC` 命令的主服务器会根据从服务器的状态返回三种回复，指示是进行全量同步、部分同步还是拒绝请求。

### 15.6 复制的实现

p211 步骤1：设置主服务器的地址和端口
p212 步骤2：建立套接字连接
p212 步骤3：发送PING命令
p213 步骤4：身份验证
p214 步骤5：发送端口信息
p215 步骤6：同步
p216 步骤7：命令传播

复制的实现过程包括以下步骤：

1. 设置主服务器的地址和端口。
2. 建立套接字连接。
3. 发送 `PING` 命令以测试连接。
4. 进行身份验证。
5. 发送端口信息以便从服务器连接。
6. 执行同步过程，进行数据传输。
7. 传播命令，确保从服务器能够接收到主服务器的写命令。

### 15.7 心跳检测

p216 发送REPLCONF ACK命令对于主从服务器有三个作用
p216 检测主从服务器的网络连接状态
p217 辅助实现min-slaves配置选项
p127 检测命令丢失
p218 Redis2.8版本以前的命令丢失

心跳检测通过发送 `REPLCONF ACK` 命令实现，主要有三个作用：

1. 检测主从服务器的网络连接状态，确保连接的稳定性。
2. 辅助实现 `min-slaves` 配置选项，确保在达到最小从服务器数量时进行写操作。
3. 检测命令丢失，确保从服务器能够及时接收到主服务器的所有写命令。

在 Redis 2.8 版本以前，命令丢失的问题较为严重，导致数据不一致，因此新版复制机制通过改进的心跳检测和部分重同步功能，显著提高了复制的可靠性和效率。

------

Redis 的复制功能通过实现主从复制机制，确保了数据的高可用性和冗余。旧版复制功能依赖于 `SYNC` 命令，存在初次复制和断线后重复制的效率问题。新版复制引入了完整重同步和部分重同步的概念，通过复制偏移量和复制积压缓冲区实现高效的数据同步。`PSYNC` 命令的实现使得主从服务器能够灵活地进行数据同步，心跳检测机制则确保了连接的稳定性和命令的完整性。这些机制的优化使得 Redis 在高并发环境下能够保持数据一致性和系统的高可用性。

## 第十六章 Sentinel

p219 Sentinel
p220 故障转移操作

Redis Sentinel 是 Redis 的高可用性解决方案，负责监控 Redis 主服务器和从服务器的健康状况，并在主服务器出现故障时自动进行故障转移。Sentinel 通过多个 Sentinel 实例组成的集群实现高可用性和容错能力。这一章详细介绍了 Sentinel 的启动与初始化、获取服务器信息、主观下线与客观下线状态检测、领头 Sentinel 的选举以及故障转移的实现。

### 16.1 启动并初始化Sentinel

p220 启动一个Sentinel可以使用命令redis-sentinel
p221 当一个Sentinel启动时，它需要以下步骤
p221 初始化服务器
p221 Sentinel模式下Redis服务器主要功能的使用情况
p222 使用Sentinel专用代码
p222 初始化Sentinel状态
p223 初始化Sentinel状态的master属性
p223 每个sentinelRedisInstence结构代表一个被监视的Redis服务器实例
p226 创建连向主服务器的网络连接
p226 Sentinel会创建两个连向主服务器的异步网络连接

启动一个 Sentinel 实例可以使用 `redis-sentinel` 命令。当一个 Sentinel 启动时，需要执行以下初始化步骤：

1. **初始化服务器**：包括设置服务器的模式为 Sentinel 模式，禁用一些不必要的功能（如集群模式、Lua 脚本支持等）。
2. **使用 Sentinel 专用代码**：替换了某些通用服务器功能的实现，以适应 Sentinel 的特殊需求。
3. **初始化 Sentinel 状态**：
   - 创建一个 `sentinelRedisInstance` 结构体，代表被监视的每个 Redis 服务器实例。
   - 初始化 Sentinel 状态的 `master` 属性，记录主服务器的相关信息。
   - Sentinel 会创建两个异步网络连接到主服务器，用于命令连接和订阅连接。

### 16.2 获取主服务器信息

p227 主服务器INFO命令回复

Sentinel 通过向主服务器发送 `INFO` 命令获取其状态信息，包括主服务器的运行 ID、角色、从服务器列表等。这些信息用于更新 Sentinel 对主服务器状态的感知。

### 16.3 获取从服务器信息

p229 从服务器INFO命令回复

Sentinel 同样通过向从服务器发送 `INFO` 命令获取其状态信息。这些信息包括从服务器的运行 ID、复制偏移量、与主服务器的连接状态等，用于监控从服务器的健康状况。

### 16.4 向主服务器和从服务器发送信息

p230 信息中和Sentinel有关的参数
p231 信息中和主服务器有关的参数

Sentinel 在与主服务器和从服务器通信时，会发送包含 Sentinel 专用参数的信息，例如：

- **信息中与 Sentinel 有关的参数**：如 Sentinel 的 IP 地址、端口号、运行 ID 等。
- **信息中与主服务器有关的参数**：如主服务器的当前时代（current epoch）、配置版本号等。

### 16.5 接收来自主服务器和从服务器的频道信息

p232 更新sentinels字典
p234 创建连向其他Sentinel的命令连接
p234 Sentinel之间不会创建订阅连接

Sentinel 通过订阅频道接收来自主服务器和从服务器的信息更新。这些更新包括：

- **更新 `sentinels` 字典**：记录其他 Sentinel 的信息，如 IP 地址、端口号、运行 ID 等。
- **创建连向其他 Sentinel 的命令连接**：用于与其他 Sentinel 通信，但不会创建订阅连接。

### 16.6 检测主观下线状态

p235 down-after-milliseconds选项
p235 主观下线时长选项的作用范围
p236 多个Sentinel设置的主观下线时长可能不同

Sentinel 通过 `down-after-milliseconds` 选项设置主观下线（Subjectively Down, SFD）的超时时间。当 Sentinel 与服务器的连接在指定时间内未收到回复时，会将服务器标记为 SFD。不同 Sentinel 设置的主观下线超时时间可能不同，这取决于配置文件中的设置。

### 16.7 检查客观下线状态

p236 发送SENTINEL is-master-down-by-addr命令
p237 接收SENTINEL is-master-down-by-addr命令
p237 接收SENTINEL is-master-down-by-addr命令的回复
p238 客观下线状态的判断条件

在确认服务器是否客观下线（Objectively Down, OOD）时，Sentinel 会向其他 Sentinel 发送 `SENTINEL is-master-down-by-addr` 命令，请求其他 Sentinel 的意见。如果大多数 Sentinel 认为服务器已下线，则标记服务器为 OOD。此过程涉及以下步骤：

- **发送 `SENTINEL is-master-down-by-addr` 命令**：询问其他 Sentinel 是否认为服务器已下线。
- **接收回复**：统计其他 Sentinel 的回复，确定多数意见。
- **判断客观下线状态**：如果多数 Sentinel 认为服务器已下线，则标记为 OOD。

### 16.8 选举领头Sentinel

当一个主服务器被判断为客观下线时进行选举

当主服务器被判断为 OOD 时，Sentinel 集群会选举一个领头 Sentinel 来执行故障转移。选举过程基于特定的规则，例如根据 Sentinel 的优先级、运行时间等选择领头 Sentinel。

### 16.9 故障转移

p240 故障转移的三个步骤
p241 选出新的主服务器
p241 新的主服务器是怎样挑选出来的
p242 修改从服务器的复制目标
p243 将旧的主服务器变为从服务器

故障转移是 Sentinel 的核心功能之一，包括以下三个步骤：

1. **选出新的主服务器**：
   - 从可用的从服务器中选择一个作为新的主服务器。
   - 选择过程中会考虑从服务器的优先级、复制偏移量、与主服务器的连接状态等因素。
   - 如果没有合适的从服务器，Sentinel 可能会等待或创建一个新的主服务器。
2. **修改从服务器的复制目标**：
   - 将所有从服务器重新配置为复制新的主服务器。
   - 通过向从服务器发送 `SLAVEOF` 命令实现。
3. **将旧的主服务器变为从服务器**：
   - 旧的主服务器在恢复后会被配置为跟随新的主服务器。
   - 通过向旧的主服务器发送 `SLAVEOF` 命令实现。

------

Redis Sentinel 是 Redis 实现高可用性的关键组件，通过监控主服务器和从服务器的健康状况，自动进行故障转移，确保系统的持续可用性。Sentinel 的启动和初始化过程包括设置服务器模式、加载配置、创建网络连接等。Sentinel 通过发送和接收 `INFO` 命令获取服务器信息，并通过主观下线和客观下线状态检测机制判断服务器的健康状况。在主服务器出现故障时，Sentinel 会选举领头 Sentinel 执行故障转移，包括选出新的主服务器、修改从服务器的复制目标以及将旧的主服务器变为从服务器。这些机制确保了 Redis 集群在高并发环境下能够自动恢复并保持数据的一致性和可靠性。

## 第十七章 集群

Redis Cluster 是 Redis 的分布式解决方案，通过将数据分布在多个节点上，实现数据的水平扩展和高可用性。这一章详细介绍了 Redis 集群的节点管理、槽指派、命令执行、重新分片、错误处理、复制与故障转移以及消息传递机制。

### 17.1 节点

p245 CLUSTER MEET命令
p247 启动节点
p247 集群数据结构
p247 clusterNode结构
p248 clusterLink结构
p249 clusterState结构
p250 CLUSLTER MEET命令的实现

Redis 集群由多个节点组成，每个节点负责处理一部分数据。节点之间的通信通过 `CLUSTER MEET` 命令实现，该命令用于将一个节点引入到集群中。

- **启动节点**：节点启动时会初始化集群数据结构，包括 `clusterNode`、`clusterLink` 和 `clusterState` 等结构体。
  - `clusterNode`：表示集群中的一个节点，包含节点的地址、状态、槽指派信息等。
  - `clusterLink`：表示节点之间的连接，用于节点间通信。
  - `clusterState`：表示集群的状态，包括节点列表、槽指派信息等。
- **`CLUSTER MEET` 命令的实现**：当一个节点收到 `CLUSTER MEET` 命令时，会向指定的节点发送 `MEET` 消息，将该节点引入到集群中。

### 17.2 槽指派

p253 记录节点的槽指派信息
p254 传播节点的槽指派信息
p255 记录集群所有槽的指派信息
p257 CLUSTER ADDSLOTS命令的实现

Redis 集群通过槽（slot）来分配数据，每个槽由一个节点负责处理。槽指派信息记录在节点的 `clusterState` 结构中。

- **记录节点的槽指派信息**：当节点加入集群时，需要将其负责的槽指派给该节点。
- **传播节点的槽指派信息**：节点会将槽指派信息传播给其他节点，确保所有节点的槽指派信息一致。
- **记录集群所有槽的指派信息**：集群中的每个节点都维护一份完整的槽指派信息，记录每个槽由哪个节点负责。
- **`CLUSTER ADDSLOTS` 命令的实现**：当节点收到 `CLUSTER ADDSLOTS` 命令时，会将指定的槽指派给该节点，并更新槽指派信息。

### 17.3 在集群中的执行命令

p260 计算键属于哪个槽
p260 判断槽是否由当前节点负责处理
p261 MOVED错误
p261 节点数据库的实现
p261 slots_to_key跳跃表

在集群中执行命令时，需要根据键的哈希值计算出该键属于哪个槽，然后将命令转发到负责该槽的节点。

- **计算键属于哪个槽**：通过哈希函数计算键的哈希值，然后根据哈希值确定键属于哪个槽。
- **判断槽是否由当前节点负责处理**：节点会检查计算出的槽是否由自己负责，如果是，则执行命令；如果不是，则返回 `MOVED` 错误，指示客户端将命令发送到正确的节点。
- **`MOVED` 错误**：当节点不负责处理某个槽时，会返回 `MOVED` 错误，告诉客户端正确的节点地址。
- **节点数据库的实现**：每个节点维护自己的数据库，存储分配给自己的槽的数据。
- **`slots_to_key` 跳跃表**：节点使用跳跃表来快速查找键所属的槽。

### 17.4 重新分片

p266 重新分片的实现原理

重新分片是 Redis 集群中用于调整槽指派的过程，通常在节点加入或离开集群时进行。

- **重新分片的实现原理**：重新分片通过将槽从一个节点迁移到另一个节点来实现。迁移过程中，源节点会将槽的数据发送给目标节点，然后更新槽指派信息。

### 17.5 ASK错误

p268 CLUSTER SETSLOT IMPORTING命令的实现
p269 CLUSTER SETSLOT MIGRATING命令的实现
p270 ASK错误

p271 ASKING命令

p273 ASK错误和MOVED错误的区别

在重新分片过程中，可能会出现 `ASK` 错误，指示客户端需要将命令发送到另一个节点。

- **`CLUSTER SETSLOT IMPORTING` 命令的实现**：当节点收到 `CLUSTER SETSLOT IMPORTING` 命令时，会开始导入指定的槽。
- **`CLUSTER SETSLOT MIGRATING` 命令的实现**：当节点收到 `CLUSTER SETSLOT MIGRATING` 命令时，会开始迁移指定的槽。
- **`ASK` 错误**：当节点正在迁移槽时，会返回 `ASK` 错误，告诉客户端将命令发送到正在导入该槽的节点。
- **`ASKING` 命令**：客户端收到 `ASK` 错误后，可以发送 `ASKING` 命令，告诉节点自己已经知道需要将命令发送到另一个节点。
- **`ASK` 错误和 `MOVED` 错误的区别**：`ASK` 错误表示槽正在迁移，客户端需要将命令发送到另一个节点；`MOVED` 错误表示槽已经迁移完成，客户端需要将命令发送到新的节点。

### 17.6 复制与故障转移

p275 设置从节点
p278 故障检测
p280 故障转移
p280 选举新的主节点

Redis 集群中的节点可以设置从节点，用于数据备份和故障转移。

- **设置从节点**：通过 `CLUSTER REPLICATE` 命令，可以将一个节点设置为另一个节点的从节点。
- **故障检测**：节点会定期检测主节点的状态，如果主节点出现故障，从节点会发起故障转移。
- **故障转移**：故障转移过程中，从节点会成为新的主节点，其他节点会更新槽指派信息。
- **选举新的主节点**：在故障转移过程中，集群会选举一个新的主节点，通常选择优先级最高的从节点。

### 17.7 消息

p282 消息头
p284 MEET、PING、PONG消息的实现
p284 Gossip协议
p285 FAIL消息的实现
p286 PUBLISH消息的实现

Redis 集群中的节点通过消息传递机制进行通信，消息包括 `MEET`、`PING`、`PONG`、`FAIL` 和 `PUBLISH` 等。

- **消息头**：消息头包含消息的类型、发送者和接收者的地址等信息。
- **`MEET`、`PING`、`PONG` 消息的实现**：这些消息用于节点间的通信和状态检测。
- **Gossip 协议**：节点通过 Gossip 协议传播集群中的状态信息，如节点的加入、离开和故障等。
- **`FAIL` 消息的实现**：当节点检测到主节点故障时，会发送 `FAIL` 消息，通知其他节点主节点已经故障。
- **`PUBLISH` 消息的实现**：当节点需要发布消息时，会发送 `PUBLISH` 消息，将消息发送给订阅该频道的节点。

### 

Redis 集群通过将数据分布在多个节点上，实现了数据的水平扩展和高可用性。节点管理、槽指派、命令执行、重新分片、错误处理、复制与故障转移以及消息传递机制共同构成了 Redis 集群的核心功能。通过这些机制，Redis 集群能够在高并发环境下保持高性能和高可靠性，确保数据的一致性和系统的可用性。

## 总结

Redis 的多机数据库实现主要涉及 Sentinel 和 Cluster 两大部分，提供了高可用性、容错性和数据分布能力。Sentinel 负责监控和自动故障转移，而 Cluster 实现了数据的分布式存储和访问。通过这些功能，Redis 能够在多机环境下保持高性能、高可用性，并支持大规模数据存储和处理。

------

### Redis Sentinel

Redis Sentinel 是 Redis 的高可用性解决方案，通过多个 Sentinel 实例组成的集群实现对 Redis 主服务器和从服务器的监控、故障检测和自动故障转移。Sentinel 的主要功能包括：

1. **启动并初始化 Sentinel**：
   - 使用 `redis-sentinel` 命令启动 Sentinel 实例。
   - Sentinel 初始化服务器，设置为 Sentinel 模式，禁用不必要的功能。
   - 初始化 Sentinel 状态，包括主服务器和从服务器的信息。
2. **获取主服务器和从服务器信息**：
   - 通过发送 `INFO` 命令获取主服务器和从服务器的状态信息。
   - 更新 Sentinel 对主服务器和从服务器状态的感知。
3. **主观下线与客观下线状态检测**：
   - **主观下线（Subjectively Down, SFD）**：Sentinel 根据 `down-after-milliseconds` 选项判断服务器是否下线。
   - **客观下线（Objectively Down, OOD）**：Sentinel 通过向其他 Sentinel 发送 `SENTINEL is-master-down-by-addr` 命令，确认服务器是否下线。
4. **选举领头 Sentinel**：
   - 当主服务器被判断为客观下线时，Sentinel 集群会选举一个领头 Sentinel 来执行故障转移。
5. **故障转移**：
   - 领头 Sentinel 选出新的主服务器，将从服务器配置为新主服务器的从服务器。
   - 修改从服务器的复制目标，确保数据一致性和系统可用性。

------

### Redis Cluster

Redis Cluster 是 Redis 的分布式解决方案，通过将数据分布在多个节点上，实现数据的水平扩展和高可用性。Cluster 的主要功能包括：

1. **节点管理**：
   - 使用 `CLUSTER MEET` 命令将节点引入集群。
   - 每个节点维护 `clusterNode`、`clusterLink` 和 `clusterState` 等结构体，记录节点信息和集群状态。
2. **槽指派**：
   - Redis Cluster 使用 16384 个槽来分配数据，每个槽由一个节点负责处理。
   - 节点通过 `CLUSTER ADDSLOTS` 命令指派槽，并记录和传播槽指派信息。
3. **命令执行**：
   - 根据键的哈希值计算出键所属的槽，将命令转发到负责该槽的节点。
   - 如果节点不负责处理某个槽，会返回 `MOVED` 错误，指示客户端将命令发送到正确的节点。
4. **重新分片**：
   - 重新分片是调整槽指派的过程，通常在节点加入或离开集群时进行。
   - 源节点将槽的数据发送给目标节点，然后更新槽指派信息。
5. **ASK 错误**：
   - 在重新分片过程中，可能会出现 `ASK` 错误，指示客户端需要将命令发送到另一个节点。
   - 客户端收到 `ASK` 错误后，可以发送 `ASKING` 命令，告诉节点自己已经知道需要将命令发送到另一个节点。
6. **复制与故障转移**：
   - 通过 `CLUSTER REPLICATE` 命令设置从节点，实现数据备份和故障转移。
   - 当主节点出现故障时，从节点会发起故障转移，选举新的主节点，确保系统的高可用性。
7. **消息传递**：
   - 节点通过 `MEET`、`PING`、`PONG`、`FAIL` 和 `PUBLISH` 等消息进行通信。
   - Gossip 协议用于传播集群中的状态信息，如节点的加入、离开和故障等。

Redis 的多机数据库实现通过 Sentinel 和 Cluster 提供了高可用性、容错性和数据分布能力。Sentinel 负责监控和自动故障转移，确保系统的高可用性；Cluster 实现了数据的分布式存储和访问，支持大规模数据存储和处理。这些功能的高效设计和实现，使得 Redis 能够在多机环境下保持高性能、高可用性，并支持大数据量的存储和处理。通过合理的配置和管理，Redis 能够在高并发和大规模数据场景中发挥重要作用，成为现代分布式系统中的重要组成部分。